#!/usr/bin/env bash
# Install grov CLI: copy grov and completion into a dir on PATH; optionally add completion to ~/.bashrc.
# Usage: ./install [BIN_DIR]
#   BIN_DIR  default: ~/.local/bin (common per-user location, usually already on PATH)
set -e
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="${1:-$HOME/.local/bin}"

mkdir -p "$BIN_DIR"
if [[ -f "$BIN_DIR/grov" || -f "$BIN_DIR/grov-completion.bash" ]]; then
  echo -n "grov already installed at $BIN_DIR. Overwrite? [y/N] "
  read -r ans
  if [[ "$ans" != [yY]* ]]; then
    echo "Skipped."
    exit 0
  fi
fi
cp "$SCRIPT_DIR/grov" "$BIN_DIR/grov"
chmod +x "$BIN_DIR/grov"
if [[ -f "$SCRIPT_DIR/grov-completion.bash" ]]; then
  cp "$SCRIPT_DIR/grov-completion.bash" "$BIN_DIR/grov-completion.bash"
fi
echo "Installed: $BIN_DIR/grov"

if [[ ":$PATH:" != *":$BIN_DIR:"* ]]; then
  echo "Note: ensure $BIN_DIR is on your PATH (e.g. add to ~/.bashrc: export PATH=\"\$HOME/.local/bin:\$PATH\")."
fi

BASHRC="${BASHRC:-$HOME/.bashrc}"
COMPLETION="$BIN_DIR/grov-completion.bash"
if [[ -f "$COMPLETION" && -f "$BASHRC" ]]; then
  if grep -qF "grov-completion.bash" "$BASHRC" 2>/dev/null; then
    echo "Completions already in $BASHRC (reload with: source $BASHRC)"
  else
    echo -n "Add completions to ~/.bashrc? [y/N] "
    read -r ans
    if [[ "$ans" == [yY]* ]]; then
      echo "" >> "$BASHRC"
      echo "# grov completion" >> "$BASHRC"
      echo "source $COMPLETION" >> "$BASHRC"
      echo "Added completion to $BASHRC"
      echo -n "Run 'source ~/.bashrc' to enable now? [y/N] "
      read -r ans2
      if [[ "$ans2" == [yY]* ]]; then
        source "$BASHRC"
        echo "Done."
      fi
    fi
  fi
fi
