#!/usr/bin/env bash
# Install grov CLI: copy grov and completion into a dir on PATH; optionally add completion to ~/.bashrc.
# Usage: ./install [BIN_DIR]
#   BIN_DIR  default: ~/.local/bin (common per-user location, usually already on PATH)
set -e
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
BIN_DIR="${1:-$HOME/.local/bin}"

mkdir -p "$BIN_DIR"
if [[ -f "$BIN_DIR/grov" || -f "$BIN_DIR/grov-completion.bash" ]]; then
  echo -n "grov already installed at $BIN_DIR. Overwrite? [y/N] "
  read -r ans
  if [[ "$ans" != [yY]* ]]; then
    echo "Skipped."
    exit 0
  fi
fi
cp "$SCRIPT_DIR/grov" "$BIN_DIR/grov"
chmod +x "$BIN_DIR/grov"
if [[ -f "$SCRIPT_DIR/grov-completion.bash" ]]; then
  cp "$SCRIPT_DIR/grov-completion.bash" "$BIN_DIR/grov-completion.bash"
fi
echo "Installed: $BIN_DIR/grov"

BASHRC="${BASHRC:-$HOME/.bashrc}"
if [[ ":$PATH:" != *":$BIN_DIR:"* ]] && [[ -f "$BASHRC" ]]; then
  if ! grep -qF "$BIN_DIR" "$BASHRC" 2>/dev/null; then
    echo -n "Add $BIN_DIR to PATH in $BASHRC? [y/N] "
    read -r ans
    if [[ "$ans" == [yY]* ]]; then
      echo "" >> "$BASHRC"
      echo "# grov (add bin to PATH)" >> "$BASHRC"
      echo "export PATH=\"$BIN_DIR:\$PATH\"" >> "$BASHRC"
      echo "Added to $BASHRC. Run: source $BASHRC"
    else
      echo "Note: ensure $BIN_DIR is on your PATH (e.g. add to $BASHRC: export PATH=\"$BIN_DIR:\$PATH\")."
    fi
  fi
fi

COMPLETION="$BIN_DIR/grov-completion.bash"
if [[ -f "$COMPLETION" ]]; then
  if [[ -f "$BASHRC" ]]; then
    grep -qF "grov-completion.bash" "$BASHRC" 2>/dev/null || {
      echo "" >> "$BASHRC"
      echo "# grov completion" >> "$BASHRC"
      echo "source $COMPLETION" >> "$BASHRC"
    }
  fi
  source "$COMPLETION"
fi
